<!DOCTYPE html>
<html lang="en">
<!-- check -->
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Line Scatter Loess</title>



  <!-- CSS  -->
  <style>
    .slidecontainer {
      width: 100%;
    }

  </style>

  <script type="text/javascript" src="data/line_scatter.json"></script>
  

</head>

<body id="page-top">

  <h1>Custom Range Slider</h1>

  <div class="slidecontainer">
    <p>Default range slider:</p>
    <input type="range" min="1" max="100" value="50" id="myRange">
    <div id='slideroutput'>50</div>
  </div>
  
  <div class='chart'></div>

  <!-- Leaflet javascript -->
  <script src="https://unpkg.com/d3-regression@1.3.9/dist/d3-regression.min.js"></script>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>

  <!-- Web app  -->
  <script>


    const data = JSON.parse(line_scatter_json); 

    data.map(d=> d['date'] = new Date(d['date']))
    data.map(d=> d['value'] = +d['value'])

    // Slider
    var slider = document.getElementById("myRange");
    var slideroutput = document.getElementById("slideroutput");

    slider.oninput = function(){
      slideroutput.innerHTML = this.value
    }

  //   // ###########################################
  //   // inspiration:  https://observablehq.com/@harrystevens/global-temperature-trends-1880-2019-with-trend-line

    const width =1400; 
    const height = 700;
    const margin = {top:40,right:30,bottom:30,left:40};
    


    var xScale = d3.scaleTime()
      .domain(d3.extent(data, d=> d.date))
      .range([margin.left, width - margin.right ]); 

    var yScale = d3.scaleLinear()
      .domain(d3.extent(data, d=> d.value)).nice()
      .range([height - margin.bottom, margin.top]); 

    //  color scale
    var max = d3.quantile(data, 0.9975, d => Math.abs(d.value));
    var colorScale = d3.scaleSequential(d3.interpolatePiYG).domain([-max, +max]);

 
  

  svg = d3.select('.chart')
    .append('svg')
    .attr('viewBox', [0,0,width ,height]);

  svg.append("g")
    .call(d3.axisBottom(xScale).ticks(width/80).tickSizeOuter(0))
    .attr("transform", `translate(0,${height - margin.bottom})`);

  svg.append("g")
  .attr("transform", `translate(${margin.left},0)`)
    .call(d3.axisLeft(yScale).ticks(null, "+"))
    .call(g => g.select(".domain").remove())
    .call(g => g.selectAll(".tick line")
      .filter(d => d === 0)
      .clone()
        .attr("x2", width - margin.right - margin.left)
        .attr("stroke", "#ccc"))
    .call(g => g.append("text")
        .attr("fill", "#000")
        .attr("x", 5)
        .attr("y", margin.top)
        .attr("dy", "0.32em")
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text("Anomaly (Â°C)"));


  svg.append("g")
    .attr("stroke", "none")
    .selectAll("circle")
    .data(data)
    .join("circle")
      .attr("cx", d => xScale(d.date))
      .attr("cy", d => yScale(d.value))
      .attr("fill", d => colorScale(d.value))
      .attr("r", 4) ; 

  var regression = d3.regressionLoess()
    .x(d => d.date)
    .y(d => d.value)
    .bandwidth(0.1);

  line = d3.line()
    .x(d => xScale(d[0]))
    .y(d => yScale(d[1]));

    svg.selectAll("path.loess")
      .data([regression(data)])
      .join('path')      
      .attr("class","loess")
      .style("fill","none")
      .style("stroke","gray")
      .attr("d", line)


      slider.oninput = function(){

      slideroutput.innerHTML = this.value;

      // var regression = d3.regressionLoess()
      // .x(d => d.date)
      // .y(d => d.value)
      // .bandwidth( +this.value);

      // svg
      //   .selectAll("path.loess")
      //   .data([regression(data)])
      //   .join('path')
      //     .attr("class","loess")
      //     .style("stroke","gray")
      //     .attr("fill", "none")
      //     .attr("d", line)

    }






  </script>

<!-- `attrCols` generation -->

</body>
</html>
