<!DOCTYPE html>
<html lang="en">
<!-- check -->
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">


  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.4.1/math.js" type="text/JavaScript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.0/topojson.min.js"></script>


  <title>Surname Culture</title>


  <!-- Profile data -->
  <script type="text/javascript" src="tool_utils/d3_tip.js"></script>

  <script type="text/javascript" src="assets/culture_surname.json"></script>
  <script type="text/javascript" src="assets/culture_map.json"></script>
  
  <script type="text/javascript" src="assets/world_countries.json"></script>


</head>

<style>
  table, th, td {
    border:1px solid black;
  }

  .names {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
  }

    /* Tooltip CSS */
    .d3-tip {
    line-height: 1.5;
    font-weight: 400;
    font-family:"avenir next", Arial, sans-serif;
    padding: 6px;
    background: rgba(0, 0, 0, 0.6);
    color: #FFA500;
    border-radius: 1px;
    pointer-events: none;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {      
      box-sizing: border-box;
      display: inline;
      font-size: 8px;
      width: 100%;
      line-height: 1.5;
      color: rgba(0, 0, 0, 0.6);
      position: absolute;
      pointer-events: none;
      
    }

    /* Northward tooltips */
    .d3-tip.n:after {
      content: "\25BC";
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
      content: "\25C0";
      margin: -4px 0 0 0;
      top: 50%;
      left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
      content: "\25B2";
      margin: 0 0 1px 0;
      top: -8px;
      left: 0;
      text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
      content: "\25B6";
      margin: -4px 0 0 -1px;
      top: 50%;
      left: 100%;
    }

/*    text{
      pointer-events:none;
    }*/

    .details{
      color:white;
    }


</style>

<body id="page-top">

  <h2> Surname Based Culture </h2>
  <div id="world_culture"> </div>
  <div id="map_legend"> </div>

  <div id="surname_algo">
    <label for="site_search">Surname Culture Prediction:</label>
    <input type="search" id="site_search" name="q">
    
    <button id="get_culture">Search Culture</button>

    <p><strong>Predicted Culture:</strong> </p>
    <p id="pred_culture">  </p>

    <table id = 'culture_pred_tb' style="width:80%">
      <tr>
        <th>Surname</th>
        <th>Culture Prediction</th>
      </tr>
    </table>
  </div>



<script>

  // ############################################
  // LEGEND GENERATION 
  
  cultures = [... new Set(culture_map.map(r=>r.culture_agg))];

  tagID = 'surname';
  cCol = 'culture';
  chartContext = []
  chartContext[`${tagID}_${cCol}`] = {}

  legendColValues = [];
  cMap = d3.schemeCategory10;
  cultures.map(function(key,idx){
    legendColValues.push({
      column:cCol
      ,value:key
      ,text:key
      , value_len:key.length
      ,c: cMap[idx]
      ,"o":0.7,"w":6
    })
  });

  // 2. X treatment (move across)
  var xCol2_cumsum = [];
  legendColValues.map(r=>r.value_len).reduce(function(a,b,i) { return xCol2_cumsum[i] = a+b; },0);

  var box_cumsum = [];
  legendColValues.map(r=>1).reduce(function(a,b,i) { return box_cumsum[i] = a+b; },0);


  legendColValues.map((r,i) => Object.assign(r,{'value_cumsum': i===0?0:xCol2_cumsum[i-1],'box_cumsum':i===0?0:box_cumsum[i-1]}))
  legendColValues.map((r,i) => Object.assign(r,{'legX_box':r.box_cumsum*20 + r.value_cumsum *10 }))
  legendColValues.map((r,i) => Object.assign(r,{'legX_text':r.legX_box + 20 }))
  // 3. Y treatment (move down) 
  legendColValues.map((r,i) => Object.assign(r,{'line':Math.floor(r.legX_box / 1000 ) + 1 }))
  legendColValues.map((r,i) => Object.assign(r,{'legY_box':  -10 + (r.line+0) * 20  }))
  legendColValues.map((r,i) => Object.assign(r,{'legY_text': -10 + (r.line+0) * 20 + 14  }))
  //  4. Legend Line re indexing for multi line
  lineUniq = [... new Set(legendColValues.map(r=>r.line))];
  lineDF = {};
  lineUniq.map(lineID => { 
      if (lineID !==  1) {
      LineEntry = legendColValues.filter(r=> r.line === (lineID));  // take first to what you want to pull back
      lineDF[lineID] = {'line':lineID,'legX_box':LineEntry[0].legX_box,'legX_text':LineEntry[0].legX_text }
      }
  });
  legendColValues.map(row => { 
      if (row.line !== 1 ){
      Object.assign(row, {'legX_box': row.legX_box - lineDF[row.line].legX_box, 'legX_text': row.legX_text - lineDF[row.line].legX_box })
      }
  })


  // ##########################################################
  //  draw legend

  legendG = d3.select(`#map_legend`)
    .append('svg')
    .attr("width", 1000)
    .attr("height", 50);

      // UPDATE RECT
  var legend_rect = legendG
      .selectAll("rect")
      .data(legendColValues, function(d) {return d });

  legend_rect
      .attr("id","old");
  
  legend_rect.enter()
      .append("rect")
      .attr("class","legend_rect")
      .attr("id","new")
      .attr("x", d => d.legX_box )
      .attr("y", d => d.legY_box )
      .attr("width", 16)
      .attr("height", 16)
  .merge(legend_rect)
      .style("fill", function(d) { return d.c })

    legend_rect.exit().remove() ;

  // UPDATE TEXT
  var legend_txt = legendG
    .selectAll("text")
    .data(legendColValues, function(d) {  return d; });

  legend_txt
    .attr("id","old");

  legend_txt.enter()
      .append("text")
      .attr("class","legend_text")
      .attr("id","new")
      .attr("x", d => d.legX_text)
      .attr("y", d => d.legY_text)
    .merge(legend_txt)
      .text( d => d.text ? d.text : d.value)
        .style("font-weight", "bold")
      .style("font-size", "18px");
  
  legend_txt.exit().remove() ;

</script>


<script>

// inspiriation: http://bl.ocks.org/micahstubbs/8e15870eb432a21f0bc4d3d527b2d14f
var format = d3.format(",");

// Set tooltips
var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([0, 0])
            .html(function(d) {

              find_culture = culture_map.filter(f=>f.country.toUpperCase() === d.properties.name.toUpperCase());
              cnty_culture = find_culture.length > 0 ? find_culture[0].culture_agg : 'Not Specified';


              return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>Culture: </strong><span class='details'>" + cnty_culture +"</span>";
              // return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>Population: </strong><span class='details'>" + format(d.population) +"</span>";
            })

var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

var color = d3.scaleThreshold()
    .domain([10000,100000,500000,1000000,5000000,10000000,50000000,100000000,500000000,1500000000])
    .range(["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)","rgb(33,113,181)","rgb(8,81,156)","rgb(8,48,107)","rgb(3,19,43)"]);

var path = d3.geoPath();

var svg = d3.select("#world_culture")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append('g')
            .attr('class', 'map');

var projection = d3.geoMercator()
                   .scale(130)
                  .translate( [width / 2, height / 1.5]);

var path = d3.geoPath().projection(projection);

svg.call(tip);

  var populationById = {};

  svg.append("g")
      .attr("class", "countries")
    .selectAll("path")
      .data(countries.features)
    .enter().append("path")
      .attr("d", path)
      .style("fill", function(d) { 
        
        find_culture = culture_map.filter(f=>f.country.toUpperCase() === d.properties.name.toUpperCase());
        cntry_color = find_culture.length > 0 ? legendColValues.filter(f=> f.value===find_culture[0].culture_agg)[0]['c']: '#7f7f7f';
        return cntry_color; 
      
      })
      .style('stroke', 'white')
      .style('stroke-width', 1.5)
      .style("opacity",0.8)
      // tooltips
        .style("stroke","white")
        .style('stroke-width', 0.3)
        .on('mouseover',function(d){
          tip.show(d);

          d3.select(this)
            .style("opacity", 1)
            .style("stroke","white")
            .style("stroke-width",3);
        })
        .on('mouseout', function(d){
          tip.hide(d);

          d3.select(this)
            .style("opacity", 0.8)
            .style("stroke","white")
            .style("stroke-width",0.3);
        });

  svg.append("path")
      .datum(topojson.mesh(countries.features, function(a, b) { return a.id !== b.id; }))
      .attr("class", "names")
      .attr("d", path);
// }

</script>


<script>

  function model_input(surnames = [''], model = {}){
    input_set = surnames.map(s => '$' + s.toUpperCase() + '&' )
    input_set = input_set.map(surname => model.pred.map(p=> surname.includes(p) ? 1 : 0))
    return input_set
  }

  
  function matrix_dotprod(input, weights , bias , relu = true){
    var pred_weights = []
    for (pred of input){
      pred_score = []
      for (position = 0 ; position < weights[0].length ;position ++ ){
        pred_score.push(math.dot(pred , weights.map(r=>r[position])) + bias[position])
      }
      if (relu)  pred_score = pred_score.map(r=> r = r > 0 ? r : 0)
      pred_weights.push(pred_score)
    }
    return pred_weights
  }

  function output_layer(hidden_layer=[]){
    var score_output = []
    for (i=0;i<hidden_layer.length; i++){
      score_l2_exp = hidden_layer[i].map(r=> math.exp(r))
      score_output.push(score_l2_exp.map(c=>c / math.sum(score_l2_exp) ))
    }
    return score_output
  }

  function layer_uplift(layer_output=[], response_df =[]){
    var weights = response_df.map(r=>r.pctn)
    var uplift_output = []
    for (i=0;i<layer_output.length; i++){
      output_weighted = []
      for (w=0;w<weights.length;w++){
        output_weighted.push(layer_output[i][w] / weights[w] )
      }
      uplift_output.push(response_df[output_weighted.indexOf(math.max(output_weighted))])
    }
    return uplift_output
  }


  function surname_prediction(score_surnames){
    score_input = model_input(score_surnames,surname_model)
    score_layer1 = matrix_dotprod(score_input,surname_model.l1_w,surname_model.l1_b,relu = true)
    score_layer2 = matrix_dotprod(score_layer1,surname_model.l2_w,surname_model.l2_b,relu = false)
    score_output = output_layer(score_layer2) 
    score_uplift = layer_uplift(score_output,surname_model.response) 
    return score_uplift
  }


  function culture_pred_table(surname, culture){
    // append to table 
    var tableRef = document.querySelector('#culture_pred_tb');
    var newRow = tableRef.insertRow(1);
    var cell1 = newRow.insertCell(0);
    var cell2 = newRow.insertCell(1);
    cell1.innerHTML = surname;
    cell2.innerHTML = culture;
  }

  // Surname Examples
  score_surnames = ['bonpain','phillips','zhoa','rafat','chen','claremont','el-hage','georgelos','miyashiro']
  pred_surname = surname_prediction(score_surnames)
  for (w=0;w<pred_surname.length;w++){
    culture_pred_table(score_surnames[w], pred_surname[w].culture)
  }

  // Search Bar Functionality
  document.querySelector('#get_culture').onclick = function() {
    console.log('Get Culture')
    var surname_input = []
    surname_input.push(document.querySelector('#site_search').value)
    pred_surname = surname_prediction(surname_input)
    culture_pred_table(surname_input[0], pred_surname[0].culture)
    // Clear search
    document.querySelector('#site_search').value = '';

  }


</script>

</body>
</html>
